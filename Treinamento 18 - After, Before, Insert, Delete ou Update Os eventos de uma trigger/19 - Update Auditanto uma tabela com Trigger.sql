-- TRIGGER DE AUDITORIA
-- IDENTIFICANDO DATA,HORA DA EXCLUSSÃO DE PRODUTO E REGISTRANDO O DADO ANTERIOR AO UPDATE



/* TRIGGER DE AUDITORIA SERÁ USADO PARA UPDADE OU DELETE */

CREATE DATABASE LOJA;
USE LOJA;

CREATE TABLE PRODUTO(
	IDPRODUTO INT PRIMARY KEY AUTO_INCREMENT,
	NOME VARCHAR(30),
	VALOR FLOAT(10,2)
	

);




INSERT INTO PRODUTO VALUES (NULL,'LIVRO CSS',55.34);
INSERT INTO PRODUTO VALUES (NULL,'LIVRO SQL',65);
INSERT INTO PRODUTO VALUES (NULL,'LIVRO HTML',78.4);
INSERT INTO PRODUTO VALUES (NULL,'LIVRO PYTHON',64);



UPDATE PRODUTO SET VALOR = 100
WHERE IDPRODUTO =1;




/*COMANDO QUE MOSTRA DATA E HORA*/
-- QUANDO
SELECT NOW() AS "DATA E HORA";

/*MOSTRA O USUÁRIO QUE ESTÁ LOGADO */
--QUEM
SELECT CURRENT_USER() AS "USUÁRIO LOCAL";








DELIMITER $

CREATE TRIGGER BACKUP_AUDITORIA
AFTER UPDATE ON PRODUTO
FOR EACH ROW
BEGIN
	
	INSERT INTO BACKUP.BKP_PRODUTO VALUES
	(NULL,OLD.IDPRODUTO,OLD.NOME,OLD.VALOR,NEW.VALOR,NOW(),CURRENT_USER(),'U');


END
$

DELIMITER ;








CREATE DATABASE BACKUP;
USE BACKUP;

STATUS;





CREATE TABLE BKP_PRODUTO(
	IDBACKUP INT PRIMARY KEY AUTO_INCREMENT,
	IDPRODUTO INT,
	NOME VARCHAR(30),
	VALOR_ORIGINAL FLOAT(10,2),
	VALOR_ALTERADO FLOAT(10,2),
	DATA DATETIME,
	USUARIO VARCHAR(30),
	EVENTO CHAR(1)

);

